<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardiac Monitor - ECG & Pulse Oximetry</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.2/mqttws31.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            min-height: 100vh;
            color: #e0e0e0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #00ff88;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            font-family: 'Courier New', monospace;
        }
        
        .status-bar {
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid #00ff88;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
            font-family: 'Courier New', monospace;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #00ff88;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4444;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
        }
        
        .status-indicator.active {
            background: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-start {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: #000;
            font-weight: bold;
        }
        
        .btn-stop {
            background: linear-gradient(45deg, #ff4444, #cc2222);
            color: #fff;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .chart-container {
            background: #000;
            border: 2px solid #00ff88;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.3);
            margin-bottom: 20px;
            position: relative;
        }
        
        .chart-container h3 {
            color: #00ff88;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            text-align: center;
            font-size: 1.2rem;
        }
        
        .ecg-trace, .pulse-trace {
            height: 450px;
            position: relative;
            background: 
                linear-gradient(90deg, transparent 24px, rgba(0, 255, 136, 0.1) 25px, transparent 26px),
                linear-gradient(0deg, transparent 24px, rgba(0, 255, 136, 0.1) 25px, transparent 26px);
            background-size: 25px 25px;
            border-radius: 5px;
        }
        
        .ecg-grid, .pulse-grid {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(to right, rgba(0, 255, 136, 0.2) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0, 255, 136, 0.2) 1px, transparent 1px),
                linear-gradient(to right, rgba(0, 255, 136, 0.4) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0, 255, 136, 0.4) 1px, transparent 1px);
            background-size: 5px 5px, 5px 5px, 25px 25px, 25px 25px;
            pointer-events: none;
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .metric-card {
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid #00ff88;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
        }
        
        .metric-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #00ff88;
            margin-bottom: 8px;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }
        
        .metric-label {
            color: #888;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü´Ä Cardiac Monitor</h1>
            <p>Real-time ECG and Pulse Oximetry with Raspberry Pi Zero 2W</p>
        </div>
        
        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator" id="connection-status"></div>
                <span id="connection-text">Disconnected</span>
            </div>
            <div class="status-item">
                <div class="status-indicator" id="monitoring-status"></div>
                <span id="monitoring-text">Monitoring Stopped</span>
            </div>
            <div class="status-item">
                <div class="status-indicator" id="finger-status"></div>
                <span id="finger-text">No Finger Detected</span>
            </div>
            <div class="status-item">
                <span>Sample Rate: <strong id="sample-rate">0 Hz</strong></span>
            </div>
            <div class="status-item">
                <span>Buffer: <strong id="buffer-size">0</strong> samples</span>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-start" id="start-btn" onclick="startMonitoring()">
                ‚ñ∂ Start Monitoring
            </button>
            <button class="btn btn-stop" id="stop-btn" onclick="stopMonitoring()">
                ‚èπ Stop Monitoring
            </button>
        </div>
        
        <div class="chart-container">
            <h3>üìä Real-time ECG Signal - Clinical View</h3>
            <div class="ecg-trace">
                <div class="ecg-grid"></div>
                <canvas id="ecgChart"></canvas>
            </div>
        </div>
        
        <div class="chart-container">
            <h3>üìà Real-time Pulse Waveform (MAX30105)</h3>
            <div class="pulse-trace">
                <div class="pulse-grid"></div>
                <canvas id="pulseChart"></canvas>
            </div>
        </div>
        
        <div class="metrics">
            <div class="metric-card">
                <div class="metric-value" id="heart-rate-ecg">--</div>
                <div class="metric-label">Heart Rate (ECG, BPM)</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="heart-rate-pulse">--</div>
                <div class="metric-label">Heart Rate (Pulse, BPM)</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="spo2">--</div>
                <div class="metric-label">SpO‚ÇÇ (%)</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="signal-quality">--</div>
                <div class="metric-label">ECG Signal Quality</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="duration">00:00</div>
                <div class="metric-label">Recording Duration</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="samples-count">0</div>
                <div class="metric-label">Total Samples</div>
            </div>
        </div>
    </div>

    <script>
        // Socket.IO connection
        const socket = io();
        
        // MQTT connection
        const mqttClient = new Paho.MQTT.Client('raspberrypi.local', 9001, 'web_client_' + Math.random().toString(16).slice(3));
        let mqttConnected = false;
        
        mqttClient.onConnectionLost = () => {
            mqttConnected = false;
            document.getElementById('finger-status').classList.remove('active');
            document.getElementById('finger-text').textContent = 'MQTT Disconnected';
        };
        
        mqttClient.onMessageArrived = (message) => {
            const topic = message.destinationName;
            const payload = JSON.parse(message.payloadString);
            
            if (topic === 'status/data') {
                if (payload.message === 'no_finger') {
                    document.getElementById('finger-status').classList.remove('active');
                    document.getElementById('finger-text').textContent = 'No Finger Detected';
                } else {
                    document.getElementById('finger-status').classList.add('active');
                    document.getElementById('finger-text').textContent = 'Finger Detected';
                }
            } else if (topic === 'pulse/data') {
                if (payload.type === 'pulse') {
                    updatePulseChart(payload.ir_value, payload.red_value);
                }
            } else if (topic === 'metrics/data') {
                if (payload.type === 'metrics') {
                    document.getElementById('heart-rate-pulse').textContent = Math.round(payload.heart_rate);
                    document.getElementById('spo2').textContent = Math.round(payload.spo2);
                }
            }
        };
        
        function connectMQTT() {
            mqttClient.connect({
                onSuccess: () => {
                    mqttConnected = true;
                    document.getElementById('finger-status').classList.remove('active');
                    document.getElementById('finger-text').textContent = 'MQTT Connected';
                    mqttClient.subscribe('status/data');
                    mqttClient.subscribe('pulse/data');
                    mqttClient.subscribe('metrics/data');
                },
                onFailure: (err) => {
                    console.error('MQTT connection failed:', err);
                    setTimeout(connectMQTT, 5000);
                }
            });
        }
        
        // Chart configuration
        let ecgChart, pulseChart;
        let ecgDataArray = [];
        let ecgRawData = [];
        let pulseIrDataArray = [];
        let pulseRedDataArray = [];
        let maxDataPoints = 1000; // 2 seconds at 500 Hz for ECG
        let maxPulsePoints = 500; // 2 seconds at 250 Hz for pulse
        let maxAnalysisPoints = 2500; // 5 seconds for ECG analysis
        let startTime = null;
        let sampleCount = 0;
        let lastUpdateTime = 0;
        let updateInterval = 20; // 50 FPS for smooth scrolling
        let lastHeartRateUpdate = 0;
        let heartRateBuffer = [];
        let peakHistory = [];
        
        // Initialize charts
        function initCharts() {
            // ECG Chart
            const ecgCtx = document.getElementById('ecgChart').getContext('2d');
            for (let i = 0; i < maxDataPoints; i++) {
                ecgDataArray.push(1.65);
            }
            ecgChart = new Chart(ecgCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: maxDataPoints}, (_, i) => (i / 500 * 2).toFixed(2)),
                    datasets: [{
                        label: 'ECG Signal',
                        data: [...ecgDataArray],
                        borderColor: '#00ff88',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        tension: 0,
                        borderCapStyle: 'round',
                        borderJoinStyle: 'round'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time (2 second window)',
                                font: { size: 14, family: 'Courier New' },
                                color: '#00ff88'
                            },
                            grid: { display: false },
                            ticks: { display: false },
                            border: { color: '#00ff88' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Amplitude (mV)',
                                font: { size: 14, family: 'Courier New' },
                                color: '#00ff88'
                            },
                            grid: { display: false },
                            ticks: {
                                callback: function(value) {
                                    return ((value - 1.65) * 1000).toFixed(0) + ' mV';
                                },
                                color: '#00ff88',
                                font: { family: 'Courier New' }
                            },
                            border: { color: '#00ff88' },
                            min: 1.63,
                            max: 1.67
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });
            
            // Pulse Chart
            const pulseCtx = document.getElementById('pulseChart').getContext('2d');
            for (let i = 0; i < maxPulsePoints; i++) {
                pulseIrDataArray.push(0);
                pulseRedDataArray.push(0);
            }
            pulseChart = new Chart(pulseCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: maxPulsePoints}, (_, i) => (i / 250 * 2).toFixed(2)),
                    datasets: [
                        {
                            label: 'IR Signal',
                            data: [...pulseIrDataArray],
                            borderColor: '#00ccff',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            tension: 0
                        },
                        {
                            label: 'Red Signal',
                            data: [...pulseRedDataArray],
                            borderColor: '#ff4444',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            tension: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time (2 second window)',
                                font: { size: 14, family: 'Courier New' },
                                color: '#00ff88'
                            },
                            grid: { display: false },
                            ticks: { display: false },
                            border: { color: '#00ff88' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Amplitude (Raw)',
                                font: { size: 14, family: 'Courier New' },
                                color: '#00ff88'
                            },
                            grid: { display: false },
                            ticks: { color: '#00ff88', font: { family: 'Courier New' } },
                            border: { color: '#00ff88' }
                        }
                    },
                    plugins: {
                        legend: { display: true, labels: { color: '#00ff88', font: { family: 'Courier New' } } },
                        tooltip: { enabled: false }
                    }
                }
            });
        }
        
        // Socket.IO event handlers
        socket.on('connect', function() {
            document.getElementById('connection-status').classList.add('active');
            document.getElementById('connection-text').textContent = 'Socket.IO Connected';
            updateStatus();
        });
        
        socket.on('disconnect', function() {
            document.getElementById('connection-status').classList.remove('active');
            document.getElementById('connection-text').textContent = 'Socket.IO Disconnected';
        });
        
        socket.on('ecg_data', function(data) {
            if (startTime === null) {
                startTime = Date.now();
            }
            
            sampleCount++;
            
            if (ecgDataArray.length >= maxDataPoints) {
                ecgDataArray.shift();
            }
            ecgDataArray.push(data.value);
            
            if (ecgRawData.length >= maxAnalysisPoints) {
                ecgRawData.shift();
            }
            ecgRawData.push({
                value: data.value,
                timestamp: data.timestamp,
                sampleIndex: sampleCount
            });
            
            const now = Date.now();
            if (now - lastUpdateTime > updateInterval) {
                updateCharts();
                lastUpdateTime = now;
            }
            
            if (sampleCount % 250 === 0) {
                updateMetrics();
            }
        });
        
        socket.on('monitoring_started', function() {
            document.getElementById('monitoring-status').classList.add('active');
            document.getElementById('monitoring-text').textContent = 'Monitoring Active';
            startTime = Date.now();
            sampleCount = 0;
            
            ecgDataArray = [];
            ecgRawData = [];
            heartRateBuffer = [];
            peakHistory = [];
            pulseIrDataArray = [];
            pulseRedDataArray = [];
            
            for (let i = 0; i < maxDataPoints; i++) {
                ecgDataArray.push(1.65);
            }
            for (let i = 0; i < maxPulsePoints; i++) {
                pulseIrDataArray.push(0);
                pulseRedDataArray.push(0);
            }
            updateCharts();
        });
        
        socket.on('monitoring_stopped', function() {
            document.getElementById('monitoring-status').classList.remove('active');
            document.getElementById('monitoring-text').textContent = 'Monitoring Stopped';
        });
        
        // Chart update functions
        function updateCharts() {
            if (ecgChart && ecgDataArray.length > 0) {
                ecgChart.data.datasets[0].data = [...ecgDataArray];
                const minVal = Math.min(...ecgDataArray);
                const maxVal = Math.max(...ecgDataArray);
                const range = maxVal - minVal;
                const padding = Math.max(range * 0.2, 0.002);
                ecgChart.options.scales.y.min = minVal - padding;
                ecgChart.options.scales.y.max = maxVal + padding;
                ecgChart.update('none');
            }
            
            if (pulseChart && pulseIrDataArray.length > 0) {
                pulseChart.data.datasets[0].data = [...pulseIrDataArray];
                pulseChart.data.datasets[1].data = [...pulseRedDataArray];
                const allPulseData = [...pulseIrDataArray, ...pulseRedDataArray];
                const minVal = Math.min(...allPulseData);
                const maxVal = Math.max(...allPulseData);
                const range = maxVal - minVal;
                const padding = Math.max(range * 0.2, 1000);
                pulseChart.options.scales.y.min = minVal - padding;
                pulseChart.options.scales.y.max = maxVal + padding;
                pulseChart.update('none');
            }
        }
        
        function updatePulseChart(irValue, redValue) {
            if (pulseIrDataArray.length >= maxPulsePoints) {
                pulseIrDataArray.shift();
                pulseRedDataArray.shift();
            }
            pulseIrDataArray.push(irValue);
            pulseRedDataArray.push(redValue);
        }
        
        // Control functions
        function startMonitoring() {
            socket.emit('start_monitoring');
        }
        
        function stopMonitoring() {
            socket.emit('stop_monitoring');
        }
        
        // Update status from server
        function updateStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('sample-rate').textContent = data.sample_rate + ' Hz';
                    document.getElementById('buffer-size').textContent = data.buffer_size;
                })
                .catch(err => console.log('Status update error:', err));
        }
        
        // Peak detection algorithm
        function detectPeaks(voltageData, sampleRate = 500) {
            if (voltageData.length < 100) return [];
            
            const peaks = [];
            const windowSize = Math.floor(sampleRate * 0.1);
            const minPeakDistance = Math.floor(sampleRate * 0.4);
            
            const movingAvg = [];
            for (let i = 0; i < voltageData.length; i++) {
                const start = Math.max(0, i - windowSize);
                const end = Math.min(voltageData.length, i + windowSize);
                const avg = voltageData.slice(start, end).reduce((a, b) => a + b) / (end - start);
                movingAvg.push(avg);
            }
            
            const deviations = voltageData.map((val, i) => val - movingAvg[i]);
            const stdDev = Math.sqrt(deviations.reduce((a, b) => a + b * b) / deviations.length);
            const threshold = stdDev * 2;
            
            for (let i = 2; i < voltageData.length - 2; i++) {
                const currentDeviation = voltageData[i] - movingAvg[i];
                
                if (currentDeviation > threshold &&
                    voltageData[i] > voltageData[i-1] && 
                    voltageData[i] > voltageData[i+1] &&
                    voltageData[i] > voltageData[i-2] && 
                    voltageData[i] > voltageData[i+2]) {
                    if (peaks.length === 0 || (i - peaks[peaks.length - 1]) > minPeakDistance) {
                        peaks.push(i);
                    }
                }
            }
            
            return peaks;
        }
        
        // Calculate heart rate from peaks
        function calculateHeartRate(peaks, sampleRate = 500) {
            if (peaks.length < 2) return null;
            
            const intervals = [];
            for (let i = 1; i < peaks.length; i++) {
                const interval = (peaks[i] - peaks[i-1]) / sampleRate;
                if (interval > 0.3 && interval < 2.0) {
                    intervals.push(60 / interval);
                }
            }
            
            if (intervals.length === 0) return null;
            
            intervals.sort((a, b) => a - b);
            const mid = Math.floor(intervals.length / 2);
            return Math.round(intervals.length % 2 === 0 ? 
                (intervals[mid - 1] + intervals[mid]) / 2 : intervals[mid]);
        }
        
        // Calculate signal quality
        function calculateSignalQuality(voltageData) {
            if (voltageData.length < 50) return 'Poor';
            
            const mean = voltageData.reduce((a, b) => a + b) / voltageData.length;
            const variance = voltageData.reduce((a, b) => a + Math.pow(b - mean, 2)) / voltageData.length;
            const range = Math.max(...voltageData) - Math.min(...voltageData);
            
            if (variance > 0.00001 && range > 0.002) {
                return 'Excellent';
            } else if (variance > 0.000001 && range > 0.001) {
                return 'Good';
            } else if (variance > 0.0000001 && range > 0.0005) {
                return 'Fair';
            } else {
                return 'Poor';
            }
        }
        
        // Update metrics
        function updateMetrics() {
            if (startTime) {
                const duration = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                document.getElementById('duration').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            document.getElementById('samples-count').textContent = sampleCount.toLocaleString();
            
            if (ecgRawData.length > 1000) {
                const voltageData = ecgRawData.map(d => d.value);
                const peaks = detectPeaks(voltageData);
                const heartRate = calculateHeartRate(peaks);
                
                if (heartRate && heartRate >= 40 && heartRate <= 200) {
                    heartRateBuffer.push(heartRate);
                    if (heartRateBuffer.length > 5) {
                        heartRateBuffer.shift();
                    }
                    const avgHeartRate = Math.round(heartRateBuffer.reduce((a, b) => a + b) / heartRateBuffer.length);
                    document.getElementById('heart-rate-ecg').textContent = avgHeartRate;
                } else {
                    document.getElementById('heart-rate-ecg').textContent = '--';
                }
            } else {
                document.getElementById('heart-rate-ecg').textContent = '--';
            }
            
            if (ecgRawData.length > 100) {
                const recentVoltages = ecgRawData.slice(-500).map(d => d.value);
                const quality = calculateSignalQuality(recentVoltages);
                document.getElementById('signal-quality').textContent = quality;
            } else {
                document.getElementById('signal-quality').textContent = '--';
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            connectMQTT();
            updateStatus();
            setInterval(updateStatus, 5000);
        });
    </script>
</body>
</html>
